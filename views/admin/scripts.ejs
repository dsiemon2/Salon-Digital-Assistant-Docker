<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Scripts - Salon Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .sidebar { min-height: 100vh; background: #2c3e50; }
    .sidebar .nav-link { color: rgba(255,255,255,0.8); padding: 0.75rem 1rem; }
    .sidebar .nav-link:hover, .sidebar .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); }
    .sidebar .nav-link i { margin-right: 0.5rem; }
    .main-content { background: #f8f9fa; min-height: 100vh; }
    .nav-divider { border-top: 1px solid rgba(255,255,255,0.2); margin: 0.5rem 0; }
    .nav-section { color: rgba(255,255,255,0.5); font-size: 0.75rem; padding: 0.5rem 1rem; text-transform: uppercase; }
    .script-card { border-left: 3px solid #6c757d; }
    .script-card.default { border-color: #198754; }
    .script-content { font-family: 'Courier New', monospace; font-size: 0.9rem; background: #f8f9fa; padding: 10px; border-radius: 4px; }
    .variable { background: #fff3cd; padding: 2px 4px; border-radius: 2px; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <%- include('_sidebar', { token, active: 'scripts' }) %>

      <main class="col-md-10 ms-sm-auto main-content p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>AI Scripts & Responses</h2>
          <div>
            <button class="btn btn-outline-secondary me-2" onclick="seedDefaults()" data-bs-toggle="tooltip" title="Load default pre-configured scripts">
              <i class="bi bi-magic"></i> Load Defaults
            </button>
            <span data-bs-toggle="tooltip" title="Add a new script">
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#scriptModal" onclick="openScriptModal()">
                <i class="bi bi-plus-circle"></i> Add Script
              </button>
            </span>
          </div>
        </div>

        <p class="text-muted mb-4">
          Configure how your AI receptionist responds in different situations. Use variables like <code>{{salonName}}</code> for dynamic content.
        </p>

        <% categories.forEach(category => { %>
          <% if (grouped[category] && grouped[category].length > 0) { %>
          <div class="card mb-4">
            <div class="card-header bg-white">
              <h5 class="mb-0 text-capitalize"><%= category.replace('_', ' ') %></h5>
            </div>
            <div class="card-body">
              <% grouped[category].forEach(script => { %>
              <div class="script-card p-3 mb-3 bg-white rounded <%= script.isDefault ? 'default' : '' %>">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <h6 class="mb-1">
                      <%= script.title %>
                      <% if (script.isDefault) { %><span class="badge bg-success ms-2">Default</span><% } %>
                      <% if (!script.enabled) { %><span class="badge bg-secondary ms-2">Disabled</span><% } %>
                    </h6>
                    <small class="text-muted"><%= script.name %></small>
                  </div>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="editScript(<%= JSON.stringify(script).replace(/"/g, '&quot;') %>)" data-bs-toggle="tooltip" title="Edit this script">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteScript('<%= script.id %>')" data-bs-toggle="tooltip" title="Delete this script">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
                <div class="script-content mt-2">
                  <%= script.content.replace(/\{\{(\w+)\}\}/g, '<span class="variable">{{$1}}</span>') %>
                </div>
              </div>
              <% }); %>
            </div>
          </div>
          <% } %>
        <% }); %>

        <% if (scripts.length === 0) { %>
        <div class="card">
          <div class="card-body text-center py-5">
            <i class="bi bi-file-text display-4 text-muted"></i>
            <p class="mt-3 text-muted">No scripts configured yet. Click "Load Defaults" to get started with pre-configured responses.</p>
            <button class="btn btn-primary" onclick="seedDefaults()" data-bs-toggle="tooltip" title="Load default pre-configured scripts">Load Default Scripts</button>
          </div>
        </div>
        <% } %>
      </main>
    </div>
  </div>

  <!-- Script Modal -->
  <div class="modal fade" id="scriptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="scriptForm">
          <div class="modal-header">
            <h5 class="modal-title" id="scriptModalTitle">Add Script</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="id" id="scriptId">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Category *</label>
                  <select name="category" id="scriptCategory" class="form-select" required>
                    <option value="greeting">Greeting</option>
                    <option value="booking">Booking</option>
                    <option value="reschedule">Reschedule</option>
                    <option value="cancel">Cancel</option>
                    <option value="pricing">Pricing</option>
                    <option value="hours">Hours</option>
                    <option value="location">Location</option>
                    <option value="stylist">Stylist</option>
                    <option value="add_on">Add-On</option>
                    <option value="edge_case">Edge Case</option>
                    <option value="closing">Closing</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Script Name *</label>
                  <input type="text" name="name" id="scriptName" class="form-control" required placeholder="e.g., greeting_default">
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Title *</label>
              <input type="text" name="title" id="scriptTitle" class="form-control" required placeholder="e.g., Default Greeting">
            </div>
            <div class="mb-3">
              <label class="form-label">Content *</label>
              <textarea name="content" id="scriptContent" class="form-control" rows="4" required></textarea>
              <small class="text-muted">
                Available variables: <code>{{salonName}}</code>, <code>{{serviceName}}</code>, <code>{{stylistName}}</code>,
                <code>{{appointmentDate}}</code>, <code>{{appointmentTime}}</code>, <code>{{address}}</code>, <code>{{landmark}}</code>
              </small>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="isDefault" id="scriptIsDefault">
                  <label class="form-check-label" for="scriptIsDefault">Set as default for this category</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="enabled" id="scriptEnabled" checked>
                  <label class="form-check-label" for="scriptEnabled">Enabled</label>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-bs-toggle="tooltip" title="Cancel and close">Cancel</button>
            <button type="submit" class="btn btn-primary" data-bs-toggle="tooltip" title="Save script">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el) });
  </script>
  <script>
    const token = '<%= token %>';

    function openScriptModal(script = null) {
      document.getElementById('scriptModalTitle').textContent = script ? 'Edit Script' : 'Add Script';
      document.getElementById('scriptId').value = script?.id || '';
      document.getElementById('scriptCategory').value = script?.category || 'greeting';
      document.getElementById('scriptName').value = script?.name || '';
      document.getElementById('scriptTitle').value = script?.title || '';
      document.getElementById('scriptContent').value = script?.content || '';
      document.getElementById('scriptIsDefault').checked = script?.isDefault || false;
      document.getElementById('scriptEnabled').checked = script?.enabled !== false;
    }

    function editScript(script) {
      openScriptModal(script);
      new bootstrap.Modal(document.getElementById('scriptModal')).show();
    }

    document.getElementById('scriptForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);

      const res = await fetch('/admin/scripts?token=' + token, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(Object.fromEntries(formData))
      });

      if (res.ok) {
        location.reload();
      } else {
        alert('Failed to save script');
      }
    });

    async function deleteScript(id) {
      if (!confirm('Delete this script?')) return;
      await fetch('/admin/scripts/' + id + '/delete?token=' + token, { method: 'POST' });
      location.reload();
    }

    async function seedDefaults() {
      if (!confirm('This will add all default scripts. Continue?')) return;
      const res = await fetch('/admin/scripts/seed?token=' + token, { method: 'POST' });
      if (res.ok) {
        location.reload();
      } else {
        alert('Failed to seed defaults');
      }
    }
  </script>
</body>
</html>
