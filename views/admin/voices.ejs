<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voices & Languages - Salon Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <style>
    .sidebar { min-height: 100vh; background: #2c3e50; }
    .sidebar .nav-link { color: rgba(255,255,255,0.8); padding: 0.75rem 1rem; }
    .sidebar .nav-link:hover, .sidebar .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); }
    .sidebar .nav-link i { margin-right: 0.5rem; }
    .main-content { background: #f8f9fa; min-height: 100vh; }

    .voice-card {
      cursor: pointer;
      transition: all 0.3s ease;
      border: 3px solid transparent;
    }
    .voice-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .voice-card.selected {
      border-color: #0d6efd;
      box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.25);
    }
    .voice-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      margin: 0 auto 1rem;
      color: white;
    }
    .voice-card .play-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .voice-card:hover .play-btn {
      opacity: 1;
    }

    .lang-card {
      transition: all 0.2s;
    }
    .lang-card.disabled-lang {
      opacity: 0.5;
    }
    .lang-flag {
      font-size: 2rem;
      margin-right: 0.75rem;
    }

    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
    .nav-divider { border-top: 1px solid rgba(255,255,255,0.2); margin: 0.5rem 0; }
    .nav-section { color: rgba(255,255,255,0.5); font-size: 0.75rem; padding: 0.5rem 1rem; text-transform: uppercase; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <%- include('_sidebar', { token, active: 'voices' }) %>

      <main class="col-md-10 ms-sm-auto main-content p-4">
        <h2 class="mb-4"><i class="bi bi-volume-up text-primary me-2"></i>Voices & Languages</h2>

        <!-- Toast container -->
        <div class="toast-container"></div>

        <!-- Voice Selection Section -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-person-circle me-2"></i>Select Assistant Voice</h5>
          </div>
          <div class="card-body">
            <p class="text-muted mb-4">Choose the voice personality for your AI assistant. Click to select, hover to preview.</p>

            <!-- Male Voices -->
            <h6 class="text-muted mb-3"><i class="bi bi-gender-male me-2"></i>Male Voices</h6>
            <div class="row g-4 mb-4">
              <% const maleVoices = [
                { id: 'ash', name: 'Ash', desc: 'Confident & authoritative', detail: 'Clear articulation, professional tone', color: '#2c3e50' },
                { id: 'echo', name: 'Echo', desc: 'Calm & reassuring', detail: 'Soft-spoken, gentle delivery', color: '#1a5276' },
                { id: 'verse', name: 'Verse', desc: 'Dynamic & engaging', detail: 'Energetic, great for announcements', color: '#6f42c1' }
              ];
              maleVoices.forEach((voice, i) => { %>
              <div class="col-md-4 col-sm-6">
                <div class="card voice-card h-100 text-center p-3 position-relative <%= selectedVoice === voice.id ? 'selected' : '' %>"
                     data-voice="<%= voice.id %>" onclick="selectVoice('<%= voice.id %>')">
                  <button class="btn btn-sm btn-light play-btn" data-bs-toggle="tooltip" title="Preview this voice" onclick="event.stopPropagation(); previewVoice('<%= voice.id %>')">
                    <i class="bi bi-play-fill"></i>
                  </button>
                  <div class="voice-avatar" style="background: <%= voice.color %>;">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=<%= voice.id %>male&top=shortFlat,shortCurly,shortWaved&facialHair=beardLight,beardMedium,moustacheFancy&facialHairProbability=50&clothesColor=3c4f5c,65c9ff&backgroundColor=transparent"
                         alt="<%= voice.name %>" width="90" height="90">
                  </div>
                  <h5 class="mb-1"><%= voice.name %></h5>
                  <span class="badge bg-info mb-1">American English</span>
                  <small class="text-muted d-block"><%= voice.desc %></small>
                  <small class="text-muted d-block" style="font-size: 0.75rem;"><%= voice.detail %></small>
                  <% if (selectedVoice === voice.id) { %>
                  <span class="badge bg-primary mt-2"><i class="bi bi-check-lg"></i> Active</span>
                  <% } %>
                </div>
              </div>
              <% }); %>
            </div>

            <!-- Female Voices -->
            <h6 class="text-muted mb-3"><i class="bi bi-gender-female me-2"></i>Female Voices</h6>
            <div class="row g-4 mb-4">
              <% const femaleVoices = [
                { id: 'alloy', name: 'Alloy', desc: 'Neutral & balanced', detail: 'Versatile, works for any context', color: '#6c757d' },
                { id: 'ballad', name: 'Ballad', desc: 'Warm & expressive', detail: 'Emotional range, storytelling voice', color: '#d63384' },
                { id: 'coral', name: 'Coral', desc: 'Friendly & upbeat', detail: 'Cheerful, great for customer service', color: '#fd7e14' },
                { id: 'sage', name: 'Sage', desc: 'Wise & professional', detail: 'Mature, trustworthy tone', color: '#198754' },
                { id: 'shimmer', name: 'Shimmer', desc: 'Bright & energetic', detail: 'Youthful, enthusiastic delivery', color: '#0dcaf0' }
              ];
              femaleVoices.forEach((voice, i) => { %>
              <div class="col-md-4 col-sm-6">
                <div class="card voice-card h-100 text-center p-3 position-relative <%= selectedVoice === voice.id ? 'selected' : '' %>"
                     data-voice="<%= voice.id %>" onclick="selectVoice('<%= voice.id %>')">
                  <button class="btn btn-sm btn-light play-btn" data-bs-toggle="tooltip" title="Preview this voice" onclick="event.stopPropagation(); previewVoice('<%= voice.id %>')">
                    <i class="bi bi-play-fill"></i>
                  </button>
                  <div class="voice-avatar" style="background: <%= voice.color %>;">
                    <img src="https://api.dicebear.com/7.x/lorelei/svg?seed=<%= voice.id %>woman&backgroundColor=transparent"
                         alt="<%= voice.name %>" width="90" height="90">
                  </div>
                  <h5 class="mb-1"><%= voice.name %></h5>
                  <span class="badge bg-info mb-1">American English</span>
                  <small class="text-muted d-block"><%= voice.desc %></small>
                  <small class="text-muted d-block" style="font-size: 0.75rem;"><%= voice.detail %></small>
                  <% if (selectedVoice === voice.id) { %>
                  <span class="badge bg-primary mt-2"><i class="bi bi-check-lg"></i> Active</span>
                  <% } %>
                </div>
              </div>
              <% }); %>
            </div>

            <!-- Info about accents -->
            <div class="alert alert-warning mt-3">
              <h6><i class="bi bi-exclamation-triangle me-2"></i>British & Other Accents Not Available</h6>
              <p class="mb-2"><strong>OpenAI's Realtime API only offers American English voices.</strong> British, Australian, Southern US, and other accents are not currently available through OpenAI.</p>
              <p class="mb-0"><strong>For British voices and more accents:</strong> Integration with
                <a href="https://elevenlabs.io" target="_blank" class="alert-link">ElevenLabs</a> or
                <a href="https://play.ht" target="_blank" class="alert-link">PlayHT</a> would be required. These services offer:
                <ul class="mb-0 mt-2">
                  <li>British English (Male & Female)</li>
                  <li>Australian English</li>
                  <li>Southern US / Texas accent</li>
                  <li>Irish, Scottish, Indian English, and 50+ more</li>
                </ul>
              </p>
            </div>

          </div>
        </div>

        <!-- Languages Section -->
        <div class="card mb-4">
          <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-translate me-2"></i>Supported Languages</h5>
            <span data-bs-toggle="tooltip" title="Add a new language">
              <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addLanguageModal">
                <i class="bi bi-plus-lg"></i> Add Language
              </button>
            </span>
          </div>
          <div class="card-body">
            <p class="text-muted mb-4">Enable or disable languages for your voice assistant. KB content must exist for each language.</p>

            <div class="row g-3">
              <% languages.forEach(lang => { %>
              <div class="col-md-4 col-sm-6">
                <div class="card lang-card <%= !lang.enabled ? 'disabled-lang' : '' %>">
                  <div class="card-body d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                      <span class="lang-flag"><%= lang.flag || 'üåê' %></span>
                      <div>
                        <strong><%= lang.name %></strong>
                        <br><small class="text-muted"><%= lang.nativeName %> (<%= lang.code %>)</small>
                      </div>
                    </div>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox"
                             id="lang-<%= lang.code %>"
                             <%= lang.enabled ? 'checked' : '' %>
                             onchange="toggleLanguage('<%= lang.id %>', this.checked)">
                    </div>
                  </div>
                  <div class="card-footer bg-transparent border-top-0 pt-0">
                    <small class="text-muted">
                      <i class="bi bi-file-text"></i> <%= lang.docCount || 0 %> KB documents
                    </small>
                  </div>
                </div>
              </div>
              <% }); %>
            </div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="row">
          <div class="col-md-4">
            <div class="card text-center">
              <div class="card-body">
                <i class="bi bi-volume-up-fill text-primary" style="font-size: 2rem;"></i>
                <h4 class="mt-2"><%= selectedVoice %></h4>
                <small class="text-muted">Current Voice</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-center">
              <div class="card-body">
                <i class="bi bi-translate text-success" style="font-size: 2rem;"></i>
                <h4 class="mt-2"><%= languages.filter(l => l.enabled).length %></h4>
                <small class="text-muted">Active Languages</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-center">
              <div class="card-body">
                <i class="bi bi-file-text text-info" style="font-size: 2rem;"></i>
                <h4 class="mt-2"><%= typeof totalDocs !== 'undefined' ? totalDocs : languages.reduce((sum, l) => sum + (l.docCount || 0), 0) %></h4>
                <small class="text-muted">KB Documents</small>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Add Language Modal -->
  <div class="modal fade" id="addLanguageModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-plus-lg me-2"></i>Add Language</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="POST" action="/SalonSales/admin/voices/language?token=<%= token %>">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Language Code</label>
              <select class="form-select" name="code" required>
                <option value="">Select a language...</option>
                <option value="zh">Chinese (Mandarin) - ‰∏≠Êñá</option>
                <option value="vi">Vietnamese - Ti·∫øng Vi·ªát</option>
                <option value="fr">French - Fran√ßais</option>
                <option value="it">Italian - Italiano</option>
                <option value="pt">Portuguese - Portugu√™s</option>
                <option value="ja">Japanese - Êó•Êú¨Ë™û</option>
                <option value="ko">Korean - ÌïúÍµ≠Ïñ¥</option>
                <option value="ar">Arabic - ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                <option value="hi">Hindi - ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                <option value="ru">Russian - –†—É—Å—Å–∫–∏–π</option>
                <option value="pl">Polish - Polski</option>
                <option value="nl">Dutch - Nederlands</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary" data-bs-toggle="tooltip" title="Add selected language">Add Language</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el) });
  </script>
  <script>
    const token = '<%= token %>';

    function showToast(message, type = 'success') {
      const container = document.querySelector('.toast-container');
      const toast = document.createElement('div');
      toast.className = `toast show align-items-center text-bg-${type} border-0`;
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    async function selectVoice(voiceId) {
      try {
        const res = await fetch(`/admin/voices/select?token=${token}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ voice: voiceId })
        });

        if (res.ok) {
          // Update UI
          document.querySelectorAll('.voice-card').forEach(card => {
            card.classList.remove('selected');
            card.querySelector('.badge')?.remove();
          });

          const selectedCard = document.querySelector(`[data-voice="${voiceId}"]`);
          selectedCard.classList.add('selected');
          selectedCard.insertAdjacentHTML('beforeend', '<span class="badge bg-primary mt-2"><i class="bi bi-check-lg"></i> Active</span>');

          showToast(`Voice changed to ${voiceId}`);
        }
      } catch (err) {
        showToast('Failed to update voice', 'danger');
      }
    }

    function previewVoice(voiceId) {
      // Use browser speech synthesis for preview (actual OpenAI preview would need API call)
      const utterance = new SpeechSynthesisUtterance(`Hello! I'm ${voiceId}, your AI assistant for XYZ Salon.`);
      window.speechSynthesis.speak(utterance);
      showToast(`Playing preview for ${voiceId}...`, 'info');
    }

    async function toggleLanguage(langId, enabled) {
      try {
        const res = await fetch(`/admin/voices/language/${langId}?token=${token}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled })
        });

        if (res.ok) {
          const card = document.querySelector(`#lang-${langId}`)?.closest('.lang-card');
          if (card) {
            card.classList.toggle('disabled-lang', !enabled);
          }
          showToast(`Language ${enabled ? 'enabled' : 'disabled'}`);
        }
      } catch (err) {
        showToast('Failed to update language', 'danger');
      }
    }
  </script>
</body>
</html>
